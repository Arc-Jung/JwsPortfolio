장고 프레임워크 서버 개발 과정 문서
=============================================================================================
1. 디비버 설치
---------------------------------------------------------------------------------------------

2. RDS 및 데이터베이스 설정
---------------------------------------------------------------------------------------------
- 설계 작업이 마무리가 되어가는 것 보고 실제 개발을 시작하였다.
앞에 개발했던 데이터베이스를 실제로 구현하기 위해서
RDS 접속 설정 시도을 먼저 시도 하였다.

      호스트 이름 : jws.cc5v8olvshdu.us-east-2.rds.amazonaws.com
      포트 : 1521
	  SSID : LINKPLUS -> bumarket -> BUMARKET
	  사용자 이름 : jws -> bumarket -> bumarket
	  비밀번호 : ******** -> ********
	  ALTER SESSION SET CURRENT_SCHEMA = BUMARKET;

 - create user 계정명 identified by 비밀번호; 이렇게 명령어를 입력하여 새로운 계정을 생성줍니다.


- 아래와 같이 입력해주시면 자신이 만든 계정에 접근권한을 줄 수 있습니다. 
이렇게 만든 계정을 가지고 새접속을 한번 시도하였습니다.
> grant connect, resource, dba to 계정명


      create user bumarket identified by ********;
      grant connect, resource, dba to bumarket
      ALTER SESSION SET CURRENT_SCHEMA = BUMARKET;
      commit


 - EC2는 기존의 EC2를 재사용하기로 하였다. 코드의 재사용 만큼이나 서버의 재사용도 중요하다.

       호스트 이름 : jws.cc5v8olvshdu.us-east-2.rds.amazonaws.com
       포트 : 1521
       SSID : LINKPLUS
       사용자 이름 : bumarket
       비밀번호 : ********

 - init.py 는 빈 파일입니다. 이 파일은 Python에게 이 디렉토리를 하나의 Python 패키지를 구성 할 수 있도록 작성이 된 후에 실행이 됩니다.
settings.py 는 장고 프로젝트의 모든 설정을 포함하고 있습니다. 이 곳에는 우리가 만드는 어떤 application이라도 등록이 되는 곳이며,  static files의 위치, database 세부 설정 등이 들어갑니다.
urls.py 는 사이트의 url - view의 연결을 지정해줍니다. 여기에는 모든 url 매핑 코드가 포함될 수 있지만, 특정한 어플리케이션에 매핑의 일부를 할당해주는 것이 일반적입니다. 각 어플의 urls.py 에서도 
wsgi.py 는 당신의 장고 어플리케이션이 웹서버와 연결 및 소통하는 것을 돕습니다. 당신은 이것을 표준 형식(boilerplate)으로 다뤄도 무방합니다.

 - settings.py에 나의 AWS RDS 데이터베이스의 접속을 설정하였다. 대부분의 개발환경세팅을 settings.py 에서 끝낼수가 있다.

- 데이터 베이스 설정 공식 문서
  - https://docs.djangoproject.com/en/1.10/ref/settings/#databases

<code>
DATABASES = {<br>
    'default': {<br>
        'ENGINE': 'django.db.backends.oracle', <br>
        'NAME': 'near_company',  # 데이터베이스 이름<br>
        'USER': 'dev',    # 오라클 사용자 계정<br>
        'PASSWORD': 'dev123!@#',  # 오라클 패스워드<br>
        'HOST': '', 
        'PORT': ""
    }
}
</code>

데이터 베이스 테이블 생성 SQL
---------------------------------------------------------------------------------------------

<code>
CREATE TABLE "UserTB" (
	"UserId"	varchar2(20)		NOT NULL,
	"Password"	varchar2(20)		NOT NULL,
	"UserName"	varchar2(20)		NOT NULL,
	"Phone"	varchar2(20)		NOT NULL,
	"KakaoId"	varchar2(20)		NOT NULL,
	"Email"	varchar2(50)		NOT NULL
);

CREATE TABLE "UserImageTB" (
	"UserId"	varchar2(20)		NULL,
	"ImageId"	number(20)		NULL
);

CREATE TABLE "ProImageTB" (
	"ProductId"	number(20)		NULL,
	"ImageId"	number(20)		NULL
);

CREATE TABLE "ProductTB" (
	"ProductId"	number(20)		NOT NULL,
	"ProductName"	varchar2(50)		NOT NULL,
	"ProductCategory"	number(20)		NOT NULL,
	"ProductPrice"	number(20)		NOT NULL,
	"ProductText"	varchar2(3000)		NULL,
	"ProductDate"	date		NOT NULL,
	"ProductType"	number(20)		NOT NULL,
	"UserId"	varchar2(20)		NULL
);

CREATE TABLE "SaleTB" (
	"SaleId"	number(20)		NOT NULL,
	"SaleDate"	date		NOT NULL,
	"ProductId"	number(20)		NULL
);

CREATE TABLE "LikeTB" (
	"Like"	number(20)		NOT NULL,
	"UserId"	varchar2(20)		NULL,
	"ProductId"	number(20)		NULL
);

CREATE TABLE "ImageTB" (
	"ImageId"	number(20)		NOT NULL,
	"ImageName"	varchar2(1000)		NULL,
	"ImageSize"	varchar2(1000)		NULL,
	"ImageLink"	varchar2(1000)		NULL
);

ALTER TABLE "UserTB" ADD CONSTRAINT "PK_USERTB" PRIMARY KEY (
	"UserId"
);

ALTER TABLE "ProductTB" ADD CONSTRAINT "PK_PRODUCTTB" PRIMARY KEY (
	"ProductId"
);

ALTER TABLE "SaleTB" ADD CONSTRAINT "PK_SALETB" PRIMARY KEY (
	"SaleId"
);

ALTER TABLE "LikeTB" ADD CONSTRAINT "PK_LIKETB" PRIMARY KEY (
	"Like"
);

ALTER TABLE "ImageTB" ADD CONSTRAINT "PK_IMAGETB" PRIMARY KEY (
	"ImageId"
);

ALTER TABLE "UserImageTB" ADD CONSTRAINT "FK_UserTB_TO_UserImageTB_1" FOREIGN KEY (
	"UserId"
)
REFERENCES "UserTB" (
	"UserId"
);

ALTER TABLE "UserImageTB" ADD CONSTRAINT "FK_ImageTB_TO_UserImageTB_1" FOREIGN KEY (
	"ImageId"
)
REFERENCES "ImageTB" (
	"ImageId"
);

ALTER TABLE "ProImageTB" ADD CONSTRAINT "FK_ProductTB_TO_ProImageTB_1" FOREIGN KEY (
	"ProductId"
)
REFERENCES "ProductTB" (
	"ProductId"
);

ALTER TABLE "ProImageTB" ADD CONSTRAINT "FK_ImageTB_TO_ProImageTB_1" FOREIGN KEY (
	"ImageId"
)
REFERENCES "ImageTB" (
	"ImageId"
);

ALTER TABLE "ProductTB" ADD CONSTRAINT "FK_UserTB_TO_ProductTB_1" FOREIGN KEY (
	"UserId"
)
REFERENCES "UserTB" (
	"UserId"
);

ALTER TABLE "SaleTB" ADD CONSTRAINT "FK_ProductTB_TO_SaleTB_1" FOREIGN KEY (
	"ProductId"
)
REFERENCES "ProductTB" (
	"ProductId"
);

ALTER TABLE "LikeTB" ADD CONSTRAINT "FK_UserTB_TO_LikeTB_1" FOREIGN KEY (
	"UserId"
)
REFERENCES "UserTB" (
	"UserId"
);

ALTER TABLE "LikeTB" ADD CONSTRAINT "FK_ProductTB_TO_LikeTB_1" FOREIGN KEY (
	"ProductId"
)
REFERENCES "ProductTB" (
	"ProductId"
);


COMMIT
</code>
*********************************************************************
인코딩
---------------------------------------------------------------------------------------------

- #-*- coding: utf-8 -*- <br>
  - 한글을 사용하면 위에 꼭 써야함
  - https://itmining.tistory.com/115

파이썬 가상환경 설정
---------------------------------------------------------------------------------------------
  - bash sell을 사용할 경우 ~/.bash_profile 경로를
  - zsh을 사용할 경우 ~/.zshrc 경로 사용
        
	    $ echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bash_profile
		$ echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bash_profile
		$ echo 'eval "$(pyenv init -)"' >> ~/.bash_profile #입력한 환경변수 적용 
		$ source ~/.bash_profile 
		# https://ithub.tistory.com/210

포스트맨 설치
---------------------------------------------------------------------------------------------
> https://www.getpostman.com/downloads/

포스트맨은 백엔드 개발자에게 최고의 도구 중 하나이다. GET, POST 방식을 포함한 모든 통신 방식을 웹서버로 보낼 수 있으며 서버를 개발할 때 꼭 설치해야 하는 툴이다.

- 가상환경을 나갈 때 : deactivate

- #가상환경 진입 : workon testserver

- 가상환경에서 장고 설치

        virtualenv 가상환경이름
        source 가상환경이름/bin/activate
        (testserver 가상환경) pip3 install django
        (testserver 가상환경) pip3 install djangorestframework
        (testserver 가상환경) pip3 install cx_oracle
        (testserver 가상환경) pip3 install django_filter
        (testserver 가상환경) pip3 install django-rest-swagger
        (testserver 가상환경) pip3 install rest_framework_swagger
        (testserver 가상환경) cd ~/BuMarket
        (testserver 가상환경) python3 manage.py startapp 이름
        (testserver 가상환경) cd testserver0

 - 가상환경에서 서버 세팅
     
	   source 가상환경이름/bin/activate
	   (testserver 가상환경) python3 apps.py migrate
	   (testserver 가상환경) python3 apps.py runserver 0.0.0.0:8000
	   (testserver 가상환경) python3 manage.py createsuperuser
	   (testserver 가상환경) python3 manage.py runserver

 - http://rpi_IP_address:8000/ 주소로 접속해서 확인

 - 오라클 데이터베이스 인스턴스 클라이언트 설치

>https://www.oracle.com/database/technologies/instant-client/linux-x86-64-downloads.html

	   wget https://download.oracle.com/otn_software/linux/instantclient/193000/oracle-instantclient19.3-basic-19.3.0.0.0-1.x86_64.rpm
	   wget https://download.oracle.com/otn_software/linux/instantclient/193000/oracle-instantclient19.3-sqlplus-19.3.0.0.0-1.x86_64.rpm
	   wget https://download.oracle.com/otn_software/linux/instantclient/193000/oracle-instantclient19.3-devel-19.3.0.0.0-1.x86_64.rpm

	   root 권한 : sudo apt-get install alien dpkg-dev debhelper build-essential
	   root 권한 : sudo alien -c oracle basic
	   root 권한 : sudo alien -c oracle sql
	   root 권한 : sudo alien -c oracle dev
	   root 권한 : sudo dpkg -i oracle basic
	   root 권한 : sudo dpkg -i oracle sql
	   root 권한 : sudo dpkg -i oracle dev

*********************************************************************
서버 구동 메뉴얼
---------------------------------------------------------------------------------------------

- 가상환경에서의 외부접속 가능 서버 구동
	   python3 manage.py migrate
	   python3 manage.py runserver 0.0.0.0:8000
	   python3 manage.py startapp path
	   python3 manage.py startapp repath

>view.py

<code>
def tesStrtDef(request):
    rr=request.GET.get("id");
    return HttpResponse("성공"+ str(rr) + "<-리퀘스트의 값")
    
def testJsonDef(request):
    return JsonResponse({
            'message' : '안녕 파이썬 장고',
            'items' : ['파이썬', '장고', 'AWS', 'EC2'],
        }, json_dumps_params = {'ensure_ascii': True})
        
def testProductDef(request):
    return JsonResponse({
            'message' : '상품페이지',
            'items' : ['A상품'],
        }, json_dumps_params = {'ensure_ascii': True})
</code>

>urls.py

<code>
urlpatterns = [
    url('test',view.tesStrtDef, name='test'),
    url('json',view.testJsonDef, name='json'),
    url('product',view.testProductDef, name='product'),
]
</code>

- API 리스트 설치

>https://jay-ji.tistory.com/31

          pip3 install -U drf-yasg
          python3 manage.py startapp apiview

- 모델에 다음 클래스를 추가한다.


      class apiview(models.Model):
        UserId = models.CharField(primary_key=True, max_length=20)
		Password = models.CharField(max_length=20)
		UserName = models.CharField(max_length=20)\
		Phone = models.CharField(max_length=20)
    	KakaoId = models.CharField(max_length=20)
    	Email = models.CharField(max_length=50)

- 이후 콘솔에서 다음과 같이 마이그레이트한다.

      python3 manage.py makemigrations apiview
      python3 manage.py migrate apiview

이어서 생성한 모델에 값을 입력해준다. 장고는 터미널 상에서 manage.py shell 기능으로 편하게 DB를 수정할 수 있다.

$ python3 manage.py shell
>>> from member.models import Member
>>> Member.objects.create(name='tester', mail='test@test.com', age=20)
<Member: Member object (1)>
>>> Member.objects.create(name='tster2', mail='test2@test.com', age=22)
<Member: Member object (2)>

*********************************************************************
데이터베이스 마이그레이션
---------------------------------------------------------------------------------------------

(testserver 가상환경) python3 manage.py inspectdb > BuMarket/dbmodels.py
작업전 백업을 해두자

<CODE>
#-*- coding: utf-8 -*- 
# 한글을 사용하면 위에 꼭 써야함
from django.db import models
from django.contrib.auth.models import User


class UserModel(models.Model):
    UserId = models.CharField(primary_key=True, max_length=20) # AutoField
    Password = models.CharField(max_length=20)
    UserName = models.CharField(max_length=20)
    Phone = models.CharField(max_length=20)
    KakaoId = models.CharField(max_length=20)
    Email = models.CharField(max_length=50)
    
    def __str__(self):
        return self.UserId
    
class ProductModel(models.Model):
    ProductId = models.AutoField(primary_key=True,max_length=20)
    ProductName = models.CharField(max_length=50)
    ProductCategory = models.CharField(max_length=20)
    ProductPrice = models.CharField(max_length=20)
    ProductDate = models.DateTimeField(auto_now_add=True)
    ProductText = models.TextField # Long Text
    ProductType = models.CharField(max_length=20)
    #UserId = models.CharField(max_length=20) # 외래키
    
    def __str__(self):
        return self.ProductName    

class LikeModel(models.Model):
    Like = models.AutoField(primary_key=True)
    #UserId = models.CharField(max_length=20) # 외래키
    #ProductId = models.CharField(max_length=20) # 외래키

class SaleModel(models.Model):
    SaleId = models.AutoField(primary_key=True)
    SaleDate = models.DateTimeField(max_length=20)
    #ProductId = models.CharField(max_length=20) # 외래키
    
    def __str__(self):
        return self.SaleId    
    
class UserImageModel(models.Model):
    NullFiled = models.CharField(max_length=20)
    #UserId = models.CharField(primary_key=True) # 외래키
    #ImageId = models.CharField(max_length=20) # 외래키
    
    def __str__(self):
        return self.NullFiled    
    
class ProImageModel(models.Model):
    NullFiled = models.CharField(max_length=20)
    #ImageId = models.CharField(max_length=20) # 외래키
    #ProductId = models.CharField(max_length=20) # 외래키
    
    def __str__(self):
        return self.NullFiled    
    
class ImageModel(models.Model):
    ImageId = models.AutoField(primary_key=True)
    ImageName = models.TextField # Long Text
    ImageSize = models.TextField # Long Text
    ImageLink = models.TextField # Long Text

    def __str__(self):
        return self.ImageName
['/home/ubuntu/environment/BuMarket', '/home/ubuntu/environment/AlwaysOnServer/lib/python36.zip', '/home/ubuntu/environment/AlwaysOnServer/lib/python3.6', '/home/ubuntu/environment/AlwaysOnServer/lib/python3.6/lib-dynload', '/usr/lib/python3.6', '/home/ubuntu/environment/AlwaysOnServer/lib/python3.6/site-packages']
database connect
</CODE>


<code>>
database configuration settings.py
    'oracle': {
        'ENGINE': 'django.db.backends.oracle',
        'NAME': 'host:port/service',
        'USER': 'database_user',
        'PASSWORD': 'database_password',
    }

    pip uninstall django
    pip install Django==1.11.22

    cd <django application>

    python3 manage.py inspectdb --database oracle UserTB > oraclemodel.py

    pip uninstall django
    pip install Django==2.2.4
</code>

데이터베이스 테이블 생성 전 타임존 세팅
---------------------------------------------------------------------------------------------
     python3
     import pytz
     pytz.all_timezones

새로 만든 앱의 마이그레이션
---------------------------------------------------------------------------------------------
     python3 manage.py migrate
     python3 manage.py startapp apptest
     python3 manage.py makemigrations apptest
     python3 manage.py migrate apptest
     python3 manage.py createsuperuser
	 https://jamanbbo.tistory.com/43 [자기계발하는 쏭이]



shell_plus 설치
---------------------------------------------------------------------------------------------
> https://codemath.tistory.com/34

    pip3 install django-extensions


참조 및 오류 발생 내역
=============================================================================================

오라클 데이터베이스 버전 오류
---------------------------------------------------------------------------------------------
       
	django.db.migrations.exceptions.MigrationSchemaMissing: Unable to create the django_migrations table (ORA-02000: missing ALWAYS keyword)

장고 2.0 이상부터는 오류 이유 RDS 데이터베이스 버전이 11 이였다.
10월 21일
새로운 프로젝트를 생성하자.

    django-admin startproject testserver 
    python3 manage.py runserver 0.0.0.0:8000
    python3 manage.py startapp protype
    python3 manage.py makemigrations
    python3 manage.py migrate
    python3 manage.py dbshell

>setting.py

<code>
    USE_TZ = True <br>
    TIME_ZONE = 'Asia/Seoul'<br>
    LANGUAGE_CODE = 'ko'
</code>

내가 방금 만든 어플리케이션이름의 하위 폴더의 models.py에 모델들을 작성하는 것을 꼭 잊지 말자! 중요함!
python3 manage.py makemigrations protype
python3 manage.py migrate protype

디비버 같은 데이터베이스 관리툴로 데이터베이스에 들어가서 데이터베이스가 자동으로 생성 되었는지 확인하자.

home 하위폴더에 다시 들어가서 다음처럼 적자 


> admin.py 에 추가
<code>
  - from django.contrib import admin
  - from .models import UserModel # 관리자로 모델 추가 삭제를 하고 싶은 모델 입력
  - admin.site.register(UserModel) # 관리하고 싶은 모델

</code>

관리자 계정 생성
---------------------------------------------------------------------------------------------

    python3 manage.py createsuperuser
    사용자 이름 (leave blank to use 'ubuntu'): bumarketadmin
    이메일 주소: dsg890789@gmail.com
    Password: ********
    Password: ********
    비밀번호가 전부 숫자로 되어 있습니다.
    Bypass password validation and create user anyway? [y/N]: y
    Superuser created successfully.



국제표준시와 국내 시간 차이로 인한 오류
---------------------------------------------------------------------------------------------

>(20191018) ubuntu:~/environment/testserver $ python3 manage.py makemigrations protype                                                                                                      
You are trying to change the nullable field 'ProductDate' on productmodel to non-nullable without a default; we can't do that (the database needs something to populate existing rows).
Please select a fix:
 1) Provide a one-off default now (will be set on all existing rows with a null value for this column)
 2) Ignore for now, and let me handle existing rows with NULL myself (e.g. because you added a RunPython or RunSQL operation to handle NULL values in a previous data migration)
 3) Quit, and let me add a default in models.py
Select an option: 1
Please enter the default value now, as valid Python
The datetime and django.utils.timezone modules are available, so you can do e.g. timezone.now
Type 'exit' to exit this prompt
> - timezone.now() <br>
Migrations for 'protype':
  protype/migrations/0003_auto_20191022_2215.py
    - Alter field ProductDate on productmodel

해결방법  timezone.now() 추가해 주어 해결하였다.

CSRF 오류
---------------------------------------------------------------------------------------------
> https://stackoverflow.com/questions/16458166/how-to-disable-djangos-csrf-validation
> https://wayhome25.github.io/django/2017/04/01/django-ep9-crud/
> https://stackoverflow.com/questions/20963856/ 

improperlyconfigured-the-included-urlconf-project-urls-doesnt-have-any-patte
DEBUG_TOOLBAR_PATCH_SETTINGS = False

나중에 필요할 때 requirements.txt를 사용하여 필요한 라이브러리를 한번에 설치할 수 있다.
개발환경 셋업에 아주 유용함

    pip3 install -r requirements.txt

각 Model Manager의 create 함수를 통해 저장
new_post = Post.objects.create(author=User.objects.get(id=1), title='title', text='content')




*********************************************************************